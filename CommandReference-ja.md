
利用可能なコマンド
=======================================================

デフォルトでは以下のコマンドを利用できます。


システムコマンドの実行
-------------------------------------------------------

* ``System``: システムのコマンドを実行します。

  |各項目    |名前/番号  |説明                                     |
  |:---------|:----------|:----------------------------------------|
  |オプション|``command``|実行するコマンドのテキスト。             |
  |          |``showerr``|標準エラー出力を表示する場合は ``True``。|
  |入力      |1          |コマンドの標準入力に与えるテキスト。     |
  |出力      |1          |コマンドの標準出力の格納先。             |


ファイル入出力
-------------------------------------------------------

* ``Read``: ファイルを1行ずつ読み込みます。

  |各項目    |名前/番号  |説明                                     |
  |:---------|:----------|:----------------------------------------|
  |オプション|``file``   |読み込むファイルのパス。                 |
  |入力      |なし       |                                         |
  |出力      |1          |ファイルの各行の格納先。                 |

* ``Write``: ファイルに1行ずつ書き出します。

  |各項目    |名前/番号  |説明                                     |
  |:---------|:----------|:----------------------------------------|
  |オプション|``file``   |書き出し先のパス。                       |
  |          |``buff``   |バッファリングの指定。                   |
  |入力      |1          |書き出す内容。                           |
  |出力      |なし       |                                         |


生成器
-------------------------------------------------------

* ``Echo``: 指定した文字列を繰り返し出力します。

  |各項目    |名前/番号  |説明                                     |
  |:---------|:----------|:----------------------------------------|
  |オプション|``count``  |出力する回数。                           |
  |オプション|``text``   |出力する文字列。                         |
  |入力      |1          |入力の末尾になるまで文字列を繰り返し出力します。(countが指定された場合は無し) |
  |出力      |1          |文字列の出力先。                         |

* ``Seq``: 0から始まり、指定した値まで1刻みの数列を出力します。

  |各項目    |名前/番号  |説明                                     |
  |:---------|:----------|:----------------------------------------|
  |オプション|``stop``   |数列の上限。                             |
  |入力      |1          |入力の末尾になるまで数列を出力します。(stopが指定された場合は無し) |
  |出力      |1          |数列の出力先。                           |

* ``Random``: 乱数を繰り返し出力します。

  |各項目    |名前/番号  |説明                                     |
  |:---------|:----------|:----------------------------------------|
  |オプション|``count``  |出力する回数。                           |
  |入力      |1          |入力の末尾になるまで乱数を繰り返し出力します。(countが指定された場合は無し) |
  |出力      |1          |乱数の出力先。                           |


BSDソケット
-------------------------------------------------------

* ``ListeningSocket``: 指定したIPアドレス・ポート番号で接続を待ち、接続される度にソケットオブジェクトを生成します。（IPv4）

  |各項目    |名前/番号  |説明                                     |
  |:---------|:----------|:----------------------------------------|
  |オプション|``ipaddr`` |待機するIPアドレス。                     |
  |          |``port``   |待機するポート番号。                     |
  |          |``backlog``|接続キューの長さ。（規定値: 1）          |
  |入力      |なし       |                                         |
  |出力      |1          |新しい接続に対するソケットオブジェクト。 |

* ``ShutdownSocketConnection``: ソケットの読み込みまたは書き出し方向の接続を閉じます。

  |各項目    |名前/番号  |説明                                     |
  |:---------|:----------|:----------------------------------------|
  |オプション|``how``    |読み込み ``r`` または書き出し ``w`` または両方向 ``rw`` の指定。|
  |入力      |1          |ソケットオブジェクト。                   |
  |出力      |1          |ソケットオブジェクト。                   |

* ``CloseSocketConnection``: ソケットを閉じます。

  |各項目    |名前/番号  |説明                                     |
  |:---------|:----------|:----------------------------------------|
  |オプション|なし       |                                         |
  |入力      |1          |ソケットオブジェクト。                   |
  |出力      |なし       |                                         |

* ``SocketReceiveData``: ソケットを使ってデータを受信します。

  |各項目    |名前/番号  |説明                                     |
  |:---------|:----------|:----------------------------------------|
  |オプション|``size``   |受信する最大バイト数。                   |
  |          |``decode`` |受信したバイトコードを文字列にデコードする場合は文字コードを指定します。|
  |入力      |1          |ソケットオブジェクト。                   |
  |出力      |1          |ソケットオブジェクト。                   |
  |          |2          |受信したデータ。                         |

* ``SocketSendData``: ソケットを使ってデータを送信します。

  |各項目    |名前/番号  |説明                                     |
  |:---------|:----------|:----------------------------------------|
  |オプション|``decode`` |送信するデータをバイトコードにエンコードする場合は文字コードを指定します。|
  |入力      |1          |ソケットオブジェクト。                   |
  |          |2          |送信するデータ。                         |
  |出力      |1          |ソケットオブジェクト。                   |

ソケットを扱うコマンドには、入力で指定したソケットオブジェクトを出力に書き出す機能を持ったものがあります。
これは、ソケットに対するプログラムの実行順序を保証するためにあります。
この機能の重要性を理解するために、まずソケットオブジェクトが出力されない場合を考えてみましょう。

誤ったスクリプト:

    ListeningSocket:host="localhost":port=1234:backlog=5 > conn
    SocketReceiveData:size=65536:decode="utf-8" < conn > data
    CloseSocketConnection < conn
    
この例では、ソケットでデータを受信した後、ソケットを閉じる処理を期待しています。しかし、1行目が完了した時点で2行目と3行目の入力が揃うため、他のスクリプトと同様に両方とも実行可能な状態となります。
マルチスレッドでは、3行目が2行目の後に実行される保証はありません。

しかし、2行目で出力されたソケットを3行目で利用するするようにすれば、3行目が2行目の後に実行されることが保証されます。

正しく動作するスクリプト:

    ListeningSocket:host="localhost":port=1234:backlog=5 > conn
    SocketReceiveData:size=65536:decode="utf-8" < conn > conn2 data
    CloseSocketConnection < conn2

しかし、このままでは行数が増えると大量の ``conn``, ``conn1``, ``conn2`` ... を考えなければならなくなります。
幸いなことに、mt-chamber では変数の参照先を後の行で上書きできるため、単純に上から下に流れるスクリプトを組むのであれば ``conn`` の名前を変える必要はありません。

正しく動作する簡潔なスクリプト:

    ListeningSocket:host="localhost":port=1234:backlog=5 > conn
    SocketReceiveData:size=65536:decode="utf-8" < conn > conn data
    CloseSocketConnection < conn

受信内容を処理して送信する例:

    ListeningSocket:host="localhost":port=1234:backlog=5 > conn
    SocketReceiveData:size=65536:decode="utf-8" < conn > conn data
    MyCommand < data > result
    SocketSendData:encode="utf-8" < conn result > conn
    CloseSocketConnection < conn


デバッグ
-------------------------------------------------------

* ``Watch``: プロンプトモードで ``watch`` コマンドが実行された際に、指定された入力を画面に表示します。

  |各項目    |名前/番号  |説明                                     |
  |:---------|:----------|:----------------------------------------|
  |オプション|``name``   |ウォッチの名前。                         |
  |入力      |1 ...      |ウォッチする入力を1つ以上指定します。   |
  |出力      |なし       |                                         |

* ``Log``: ファイルにログを書き出します。

  |各項目    |名前/番号  |説明                                     |
  |:---------|:----------|:----------------------------------------|
  |オプション|``file``   |書き出し先のパス。                       |
  |          |``tags``   |各入力に与える名前を``;``で区切って指定します。|
  |入力      |1 ...      |書き出す変数を1つ以上指定します。        |
  |出力      |なし       |                                         |

使用例:

    MyCommand < data > result
    Seq < data > counter
    Watch:name="new_watch" < counter data result
    Log:file="log.txt":tags="Data;Result" < data result
